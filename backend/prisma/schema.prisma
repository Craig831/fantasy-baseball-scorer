generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                        String              @id @default(uuid())
  email                     String              @unique @db.VarChar(255)
  passwordHash              String              @map("password_hash") @db.VarChar(60)
  emailVerified             Boolean             @default(false) @map("email_verified")
  emailVerificationToken    String?             @map("email_verification_token") @db.VarChar(255)
  mfaEnabled                Boolean             @default(false) @map("mfa_enabled")
  mfaSecret                 String?             @map("mfa_secret") @db.VarChar(255)
  privacySettings           Json                @default("{}") @map("privacy_settings")
  createdAt                 DateTime            @default(now()) @map("created_at")
  updatedAt                 DateTime            @updatedAt @map("updated_at")
  lastLoginAt               DateTime?           @map("last_login_at")
  deletedAt                 DateTime?           @map("deleted_at")

  scoringConfigs            ScoringConfiguration[]
  lineups                   Lineup[]
  auditLogs                 AuditLog[]
  refreshTokens             RefreshToken[]
  savedSearches             SavedSearch[]

  @@index([email], name: "idx_users_email")
  @@index([emailVerified], name: "idx_users_email_verified")
  @@index([deletedAt], name: "idx_users_deleted_at")
  @@map("users")
}

model ScoringConfiguration {
  id         String   @id @default(uuid())
  userId     String   @map("user_id")
  name       String   @db.VarChar(100)
  categories Json
  isActive   Boolean  @default(false) @map("is_active")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  lineups       Lineup[]
  savedSearches SavedSearch[]

  @@unique([userId, isActive], name: "unique_active_config")
  @@index([userId], name: "idx_scoring_configs_user_id")
  @@index([userId, isActive], name: "idx_scoring_configs_user_active")
  @@map("scoring_configurations")
}

model Team {
  id            String   @id @default(uuid())
  mlbTeamId     Int      @unique @map("mlb_team_id")
  name          String   @unique @db.VarChar(100)
  abbreviation  String   @db.VarChar(10)
  league        String   @db.VarChar(2) // AL or NL
  division      String   @db.VarChar(20)
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  players       Player[]

  @@index([league], name: "idx_teams_league")
  @@index([abbreviation], name: "idx_teams_abbreviation")
  @@map("teams")
}

model Player {
  id            String              @id @default(uuid())
  mlbPlayerId   Int                 @unique @map("mlb_player_id")
  name          String              @db.VarChar(255)
  teamId        String              @map("team_id")
  position      String              @db.VarChar(20)
  status        String              @default("active") @db.VarChar(20)
  jerseyNumber  Int?                @map("jersey_number")
  season        Int
  lastUpdated   DateTime            @default(now()) @map("last_updated")
  createdAt     DateTime            @default(now()) @map("created_at")
  updatedAt     DateTime            @updatedAt @map("updated_at")

  team          Team                @relation(fields: [teamId], references: [id])
  statistics    PlayerStatistic[]
  lineupSlots   LineupSlot[]

  @@index([position], name: "idx_players_position")
  @@index([teamId], name: "idx_players_team_id")
  @@index([status], name: "idx_players_status")
  @@index([position, teamId], name: "idx_players_position_team")
  @@index([season], name: "idx_players_season")
  @@index([name], name: "idx_players_name")
  @@index([status, name], name: "idx_players_status_name")
  @@index([position, status, season], name: "idx_players_position_status_season")
  @@map("players")
}

model PlayerStatistic {
  id            String   @id @default(uuid())
  playerId      String   @map("player_id")
  season        Int
  statisticType String   @map("statistic_type") @db.VarChar(20)
  statistics    Json
  dateFrom      DateTime @map("date_from") @db.Date
  dateTo        DateTime @map("date_to") @db.Date
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  player        Player   @relation(fields: [playerId], references: [id], onDelete: Cascade)

  @@unique([playerId, season, statisticType, dateFrom, dateTo], name: "unique_player_season_stats")
  @@index([playerId], name: "idx_player_stats_player_id")
  @@index([season], name: "idx_player_stats_season")
  @@index([dateFrom, dateTo], name: "idx_player_stats_dates")
  @@map("player_statistics")
}

model Lineup {
  id                String                    @id @default(uuid())
  userId            String                    @map("user_id")
  name              String                    @db.VarChar(100)
  scoringConfigId   String?                   @map("scoring_config_id")
  projectedScore    Decimal                   @default(0.0) @map("projected_score") @db.Decimal(10, 2)
  actualScore       Decimal?                  @map("actual_score") @db.Decimal(10, 2)
  gameDate          DateTime?                 @map("game_date") @db.Date
  createdAt         DateTime                  @default(now()) @map("created_at")
  updatedAt         DateTime                  @updatedAt @map("updated_at")
  deletedAt         DateTime?                 @map("deleted_at")

  user              User                      @relation(fields: [userId], references: [id], onDelete: Cascade)
  scoringConfig     ScoringConfiguration?     @relation(fields: [scoringConfigId], references: [id], onDelete: SetNull)
  slots             LineupSlot[]

  @@index([userId], name: "idx_lineups_user_id")
  @@index([userId, gameDate], name: "idx_lineups_user_date")
  @@index([deletedAt], name: "idx_lineups_deleted_at")
  @@map("lineups")
}

model LineupSlot {
  id             String   @id @default(uuid())
  lineupId       String   @map("lineup_id")
  slotOrder      Int      @map("slot_order")
  playerId       String?  @map("player_id")
  projectedScore Decimal  @default(0.0) @map("projected_score") @db.Decimal(10, 2)
  actualScore    Decimal? @map("actual_score") @db.Decimal(10, 2)
  locked         Boolean  @default(false)
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  lineup         Lineup   @relation(fields: [lineupId], references: [id], onDelete: Cascade)
  player         Player?  @relation(fields: [playerId], references: [id], onDelete: SetNull)

  @@unique([lineupId, slotOrder], name: "unique_lineup_slot_order")
  @@unique([lineupId, playerId], name: "unique_lineup_player")
  @@index([lineupId], name: "idx_lineup_slots_lineup_id")
  @@index([playerId], name: "idx_lineup_slots_player_id")
  @@map("lineup_slots")
}

model AuditLog {
  id         String    @id @default(uuid())
  userId     String?   @map("user_id")
  action     String    @db.VarChar(50)
  entityType String?   @map("entity_type") @db.VarChar(50)
  entityId   String?   @map("entity_id") @db.VarChar(255)
  ipAddress  String    @map("ip_address") @db.VarChar(45)
  userAgent  String?   @map("user_agent") @db.Text
  metadata   Json      @default("{}")
  createdAt  DateTime  @default(now()) @map("created_at")

  user       User?     @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId, createdAt], name: "idx_audit_logs_user_created")
  @@index([action, createdAt], name: "idx_audit_logs_action_created")
  @@index([entityType, entityId], name: "idx_audit_logs_entity")
  @@map("audit_logs")
}

model RefreshToken {
  id         String    @id @default(uuid())
  userId     String    @map("user_id")
  token      String    @unique @db.VarChar(255)
  expiresAt  DateTime  @map("expires_at")
  revoked    Boolean   @default(false)
  createdAt  DateTime  @default(now()) @map("created_at")
  lastUsedAt DateTime? @map("last_used_at")

  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token], name: "idx_refresh_tokens_token")
  @@index([userId], name: "idx_refresh_tokens_user_id")
  @@index([expiresAt], name: "idx_refresh_tokens_expires_at")
  @@map("refresh_tokens")
}

model SavedSearch {
  id                      String                  @id @default(uuid())
  userId                  String                  @map("user_id")
  name                    String                  @db.VarChar(100)
  filters                 Json                    // Supports filterVersion 2 schema: {filterVersion, statisticType, positions[], season, status, dateRange, sortBy, sortOrder}
  scoringConfigurationId  String?                 @map("scoring_configuration_id")
  createdAt               DateTime                @default(now()) @map("created_at")
  updatedAt               DateTime                @updatedAt @map("updated_at")

  user                    User                    @relation(fields: [userId], references: [id], onDelete: Cascade)
  scoringConfiguration    ScoringConfiguration?   @relation(fields: [scoringConfigurationId], references: [id], onDelete: SetNull)

  @@unique([userId, name], name: "unique_user_search_name")
  @@index([userId], name: "idx_saved_searches_user_id")
  @@map("saved_searches")
}
